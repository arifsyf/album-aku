<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kenangan Kita</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    html, body {
      background: linear-gradient(to right, #ffe6f0, #ffd6ec);
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      color: #d94f92;
    }
    header, footer, .gallery, section {
      text-align: center;
      padding: 20px;
    }
    .photo-card {
      background-color: #fff0f5;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    .photo-card:hover { transform: scale(1.03); }
    .photo-card img { width: 100%; height: 200px; object-fit: cover; }
    .photo-caption { padding: 15px; }
    .photo-caption h3 { margin: 0; font-size: 1.1em; color: #c94c8e; }
    .photo-caption p { font-size: 0.9em; color: #8f3b6e; margin-top: 5px; }
    .photo-caption button {
      margin-top: 10px;
      background: #ff4d6d;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ff4d6d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button class="logout-btn" onclick="logout()">Logout</button>
  <audio id="bg-music" autoplay loop>
    <source src="bunga-abadi.mp3" type="audio/mpeg">
  </audio>

  <section>
    <h2>Upload Foto Kenangan üíó</h2>
    <input type="file" id="uploadInput" accept="image/*"><br><br>
    <input type="text" id="titleInput" placeholder="Judul Foto"><br><br>
    <textarea id="captionInput" placeholder="Ceritakan sedikit tentang foto ini..."></textarea><br><br>
    <button onclick="uploadFoto()">Upload Foto</button>
    <div id="progressContainer" style="display:none;">
      <p>Upload: <span id="progressPercent">0%</span></p>
    </div>
    <div id="spinner" style="display:none;">‚è≥ Sedang Upload sabar ya sayang...</div>
  </section>

  <section class="gallery" id="imageGallery"></section>

  <footer>
    Dibuat dengan cinta üíó oleh Kita Berdua | ¬© 2025
  </footer>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBG1-R0sYyxwK6dv7xXEEQQNPH6z_utVos",
      authDomain: "albumakuu.firebaseapp.com",
      projectId: "albumakuu",
      storageBucket: "albumakuu.appspot.com",
      messagingSenderId: "757106483844",
      appId: "1:757106483844:web:cb8349d33b8aed2c4b18d1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentUser = null;

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUser = user;
        loadGallery();
      }
    });

    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = "index.html";
      });
    }

    async function uploadFoto() {
      const fileInput = document.getElementById("uploadInput");
      const titleInput = document.getElementById("titleInput");
      const captionInput = document.getElementById("captionInput");
      const file = fileInput.files[0];
      const title = titleInput.value || "Kenangan Baru";
      const caption = captionInput.value || "Momen manis üíó";
      if (!file) return alert("Pilih file terlebih dahulu.");

      document.getElementById("spinner").style.display = "block";
      document.getElementById("progressContainer").style.display = "block";

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "kenangan_foto");
      const cloudName = "dgd4dxjpv";

      const xhr = new XMLHttpRequest();
      xhr.open("POST", `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, true);

      xhr.upload.onprogress = function (e) {
        if (e.lengthComputable) {
          const percent = Math.floor((e.loaded / e.total) * 100);
          document.getElementById("progressPercent").textContent = percent + "%";
        }
      };

      xhr.onload = async function () {
        if (xhr.status === 200) {
          const data = JSON.parse(xhr.responseText);
          await db.collection("galeri").add({
            uid: currentUser.uid,
            title,
            caption,
            url: data.secure_url,
            public_id: data.public_id,
            timestamp: new Date()
          });
          fileInput.value = "";
          titleInput.value = "";
          captionInput.value = "";
          document.getElementById("spinner").style.display = "none";
          document.getElementById("progressContainer").style.display = "none";
          document.getElementById("progressPercent").textContent = "0%";
          loadGallery();
        } else {
          alert("Upload gagal.");
        }
      };

      xhr.onerror = () => alert("Gagal mengupload ke Cloudinary");
      xhr.send(formData);
    }

    async function loadGallery() {
      if (!currentUser) return;
      const gallery = document.getElementById("imageGallery");
      gallery.innerHTML = "";
      const snapshot = await db.collection("galeri")
        .where("uid", "==", currentUser.uid)
        .orderBy("timestamp", "desc")
        .get();
      snapshot.forEach(doc => {
        const data = doc.data();
        const card = document.createElement("div");
        card.className = "photo-card";
        card.innerHTML = `
          <img src="${data.url}" alt="${data.title}">
          <div class="photo-caption">
            <h3>${data.title}</h3>
            <p>${data.caption}</p>
          </div>
        `;
        gallery.appendChild(card);
      });
    }
  </script>
</body>
</html>
